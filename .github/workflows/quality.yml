name: ðŸ›¡ï¸ Security & Quality Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # Ogni giorno alle 2 AM

jobs:
  # ðŸ” 1. SNYK SECURITY SCAN
  snyk-security:
    name: ðŸ” Snyk Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Snyk Security Scan
        uses: snyk/actions@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: |
            --severity-threshold=high \
            --fail-on=upgradable

  # ðŸ“Š 2. SONARCLOUD QUALITY SCAN
  sonarcloud-quality:
    name: ðŸ“Š SonarCloud Quality Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Importante per l'analisi accurata di SonarCloud

      - name: ðŸ” Detect project type
        id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "Detected: Node.js project"
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ]; then
            echo "Detected: Java Maven project"
            echo "language=java" >> $GITHUB_OUTPUT
          elif [ -f "requirements.txt" ]; then
            echo "Detected: Python project"
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "*.csproj" ]; then
            echo "Detected: C# project"
            echo "language=csharp" >> $GITHUB_OUTPUT
          else
            echo "Detected: Generic project"
            echo "language=generic" >> $GITHUB_OUTPUT
          fi

      # --- SETUP NODE (Se rilevato) ---
      - name: âš™ï¸ Setup Node.js
        if: steps.detect.outputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Node dependencies
        if: steps.detect.outputs.language == 'node'
        run: |
          npm ci 2>/dev/null || npm install 2>/dev/null || echo "No package.json found"

      # --- SETUP JAVA (Se rilevato - CRITICO PER IL FIX) ---
      - name: âš™ï¸ Setup Java
        if: steps.detect.outputs.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # Puoi cambiare in '11' o '21' se necessario

      - name: ðŸ“¦ Build with Maven
        if: steps.detect.outputs.language == 'java'
        # Compila il codice per generare i binari in target/classes
        run: mvn clean package -DskipTests

      # --- SONAR SCAN ---
      - name: ðŸ“Š SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=QuelloCheVuoiTu_GestorePercorsi
            -Dsonar.organization=QuelloCheVuoiTu

  # ðŸ”¬ 3. CODEQL ADVANCED SECURITY (Nativo GitHub)
  codeql-analysis:
    name: ðŸ”¬ CodeQL Advanced Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read          # <--- FIX: Necessario per scaricare il codice
      security-events: write  # Necessario per caricare i risultati
      actions: read           # Necessario per le dipendenze private (opzionale ma utile)
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, java 
        
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ðŸ“ˆ 4. COMBINED REPORT
  report:
    name: ðŸ“ˆ Combined Quality Report
    runs-on: ubuntu-latest
    needs: [snyk-security, sonarcloud-quality, codeql-analysis]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Summary Report
        run: |
          echo "ðŸŽ‰ SECURITY & QUALITY PIPELINE COMPLETED!"
          echo "========================================"
          echo "âœ… Snyk Security: Completed"
          echo "âœ… SonarCloud Quality: Completed" 
          echo "âœ… GitHub CodeQL: Completed"
          echo ""
          echo "ðŸ“Š View results at:"
          echo "- Snyk: https://app.snyk.io"
          echo "â€¢ SonarCloud: https://sonarcloud.io/project/overview?id=QuelloCheVuoiTu_GestorePercorsi"
          echo "- GitHub Security: https://github.com/${{ github.repository }}/security"
