name: ğŸ›¡ï¸ Security & Quality Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  # ğŸ” 1. SNYK SECURITY SCAN
  snyk-security:
    name: ğŸ” Snyk Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Snyk Security Scan
        uses: snyk/actions@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable

  # ğŸ“Š 2. SONARCLOUD QUALITY SCAN
  sonarcloud-quality:
    name: ğŸ“Š SonarCloud Quality Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Importante per la history di Sonar

      - name: ğŸ” Detect project type
        id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ]; then
            echo "language=java" >> $GITHUB_OUTPUT
          else
            echo "language=generic" >> $GITHUB_OUTPUT
          fi

      # --- SETUP JAVA E COMPILAZIONE (Risolve Exit Code 3) ---
      - name: âš™ï¸ Setup Java
        if: steps.detect.outputs.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # Usa la versione Java del tuo progetto (11, 17, 21)

      - name: ğŸ“¦ Build with Maven
        if: steps.detect.outputs.language == 'java'
        # Questo comando crea la cartella 'target/classes' richiesta da Sonar
        run: mvn clean package -DskipTests

      # --- SETUP NODE (Solo se serve) ---
      - name: âš™ï¸ Setup Node.js
        if: steps.detect.outputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Node dependencies
        if: steps.detect.outputs.language == 'node'
        run: npm ci 2>/dev/null || npm install 2>/dev/null

      # --- SONAR SCAN (Risolve Warning Action Deprecata) ---
      - name: ğŸ“Š SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5 # Aggiornato alla v5/v6 come richiesto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=QuelloCheVuoiTu_GestorePercorsi
            -Dsonar.organization=QuelloCheVuoiTu

  # ğŸ”¬ 3. CODEQL ADVANCED SECURITY
  codeql-analysis:
    name: ğŸ”¬ CodeQL Advanced Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read          # Risolve errore "Repository not found"
      security-events: write  # Permette di salvare i report
      actions: read
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, java 
        
      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ğŸ“ˆ 4. REPORT FINALE
  report:
    name: ğŸ“ˆ Combined Quality Report
    runs-on: ubuntu-latest
    needs: [snyk-security, sonarcloud-quality, codeql-analysis]
    if: always()
    steps:
      - name: ğŸ“‹ Summary
        run: echo "Analisi completata. Controlla la tab Security o SonarCloud per i dettagli."
